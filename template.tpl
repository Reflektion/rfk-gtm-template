___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.

___INFO___

{
  "displayName": "Reflektion",
  "description": "Template for setting up Reflektion beacon, context and events",
  "categories": [
    "ANALYTICS",
    "CONVERSIONS",
    "PERSONALIZATION"
  ],
  "securityGroups": [],
  "id": "cvt_temp_public_id",
  "type": "TAG",
  "version": 1,
  "brand": {
    "thumbnail": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADwAAAA8CAYAAAA6/NlyAAAAAXNSR0IArs4c6QAACPlJREFUaAXlWw1sHMUVnjd75xgwiSGk+C+V0ySkKGrT+GwCNEKhCImqqKWVIBCgggJChQqfTQKlFe2pkaooJPjcFomoPxCiJqL/5UeKUAuhalpSn40LDTTlL2rjs0ubxEnq2rm73en39rxm97yzt3dnJ3Yzkr0zb968ed/8vjczR2KaQkMidbY4JlYrJWIkxDJLiWWCRB0pda4gOteuVqkTiuiEUGJIkjighDhAJHrFPPH7dKL1v9OhGnSZurDoa69fODY6tk4o+jyAXiqEipYjnYgyKLdPkPpl9VnVO9/79sf+WY4cvzJTArgp3rMmJ2i9UOoaVGL4VVQBzcSI2B0RasuhZNueCuTYRSsC3Bjv/ZSlrI0YipdXqkiY8uj5vVLQNwaSsRfD8PvxlAV44QN9DdmM+Sjm3lo/odNOI/F0tMro/MfmlnSpdZUMuDGe+oyp1E5UNLfUyqaY/7hBtG4g2fp8KXJlKcwN7b0bTCGeQZnTDZbVnsu6sE6lYAjVw0u+89ackXeHv4+V99ZShJ8qXmxlO875SO1db9+39GSxOosCXrz+zx8ayWZ/jS0G28xMDvTKOdHo597ZsuL9IC0Dh7Tds7MCLENUl3LHsM5lA+ZhPPN71g0PoG2d3TRvXNvDvBjM1DnrheBNsc5BC5nvHLa3Hl6NldI2iLeaGZYismDufdZvy5oE2DYqTppvAsJM2Hoqacnj0TnGxYXGyaQetC2o2Q+WG2ruOBZPo3l6mG1jU1m/9XDM8oRB8iq37R1x42FHwJ0OE3dcOVLiT3Dn3ofPe1gpg927EoJ5JxabK4IKoJ5/k5APwlHJ6vnM6yDnC+78cUwTzsZED9sunhIvuZkD40QHkb9Z1ortlTrrde09P4Ks27X1kThBhrxycGusV8fT2Nl7rWmqX/j54BESVzqu5UQP2/4s3J+Q4Ynq2vn3HEwsGgvJXzYbemSMV9xDAWAb7u+52sqpn/mB5Yrz2MQejtuLFp9UjDvvTAsMJGjTUHfbl04FWEyPHAljrdM7forVt/ddoXL0KyWU3sLCwYSNEQJswPaxTIiTChjpL999XuzrfhVPPQ2rghJ3pLtb2DvzDU3tqVWKzOfAeLYvwwdEYxxjHrCwyDPRP+DzxqQwHkokyPJSpydFUnRgJD2lk97Q2b/SJLEbjZI/ENQxOnScs3E0wqeLalhcUmz6oncPDCRb/uiU9/su3JBabOZkmyWs8yWOI908lkEvDW1tecNN08WlpG+lu1q7dfkf7uhfnrVyLyilanU8PvRVjDWSP0pVVT4MHhIp0u7PiYSSjx9N/SCbUVhp4ZYjWAUtSJa8G+QQgOX30l2xb9pCfP41bXh1aSaT/Q2yLvDJ1pLQOFV0jFZL7FsxLZcnw96GPBQnse143zrE9duKw1jki732x4PJlvt0bM3xV5vNTI731DodTxCdseL8GwfkYYK0jujYyFSX6fJC04meX1Ybuw2gfffGpo7+xjGVexGZTaFlFjAyVmnfCBRk+CdpgT8du58U2sbQlXHTYf79LkIXXr8nQTk33YnzlmKqLPfsIodWzpexRvj6o2C6+cpSipp9M0CUFNlhilwc0Gt0PEF02LpP6vIbH3pz/ujIf3jOXqTjCU0HVmnf9YQogUm/Qsc28Ogn/haR4nKeg+D5C/74asT7p2hUVz6Iboxl5+HmYWEQT9g8xkr18dRJXsHCFDIosnIgubI/DO9U8tS1p67H6PlJpTLRIZlJ/nCQUEvl7g/Kn668oe7Wn8KkfXwq5EvY0CfCCsIKeUt9ew/vp6c8zDlvfocQ9FpFFQMrG0ShAXNlAP1YQ7znpooq1hSObUtpr1fZWZEiegPm84imeFEyY0UPi6GinF4GA8v7TsyrZ9kQ8GaVn1qe2F+VfkM9g1OX23RS0t0rDmBE3qPLL0rni3e+eS/K6Mugrs1Q7irfrBKJaxIqcmR49GmMnmtwUffdxs5+7RbEDoUk2l5iFTY7Y42gkvIAwzKCgf9DXcX1HX2tyjInFjlYOXsGu9u2+fH/9VhvO3ruunyeqrGs3C70+GX7E8t9j4ouiETv/Vc2uwpu4Uf95OlojBWNhTcVJQYof7g6etadumLNifeqhbLYtbvR+UNlq3T8UuFVhytgm2w5cnRsk4vkib62ZcWIIcUN0KOkExfGKvkBCVa/gIMxT112Qgn68sFHlmvnfmb48EYoffHkkuEp6L14Xbzv07oSh7paX0cerLtwgfdgxir5AA4ttS9cMTQN0S7eF3X8WME/iROCTl1+eDrWVGVtb96wX+sZ2VOEKKxBso+x5g0Pyad9YQKlo9VV9+o42cG2BD2J+ViSQaOTh15ecDIz+hRGC/rEP9TUzrsL/sC7/rkuKl4EccpWjJ8GIZ733F08hVGSdMffN338aCHdSVvDYhPALnHSU/EF6KuxVT2gk/V2YulxImOtPWR1TMA2jjEP2H4HhadBen4MZZh2g10xLQ+fa2NP/0qQjHLzMEU2NnX0XKIrP9jVkoKGD+ryMQ93O2+9JoYev4PSFhD0zoJodL0uH1tIDc5+n4Adph16urLh6CqaU2LXksRbc3X8g8lYEr3ie8LpxuZREHbyXmwfk95coXcflobYq6vMstTtOD65VZfPdFS0Wxq02Y8nTHlbBhGeXsif+8mwaWSdryy1FXGc3ecDhvrewWTr6om0E+HvmXCZNjGkGbB9y4ZHXxz/vwjA4r45ZEwewEzgF26Y5Mc4PqsDMNhYCkBMAsw35pgANwM0FsdZGvJPHm4uvP1nNJMAM5HfRsBR/irHZ2Ng3f3edzAWzypdCK4+3gMrJ3j1LSxzutNwEHYMJtu+qNPDt4cdZn7OhzZ5xUnP/C9e49k66zUNBMxvF/k53+wAnX96WOy9ZSBgbid+u1izeN4aHir6dju9Oawb61jsnSVrGTiHC2HwCzeLFDsIRRuqsOy0pLEa8wKV7o49ElZ+SYBZ6Bn1QJwB83LPL9wwNk6fRcY/AYAOuq2H9dSFknvYLYht71P6Iw8h/iBJPlxoLrp1KhavCLAj/Iz5GY8D2PmeMT/UcgC7vzP1p3j/A/VvXeZabpDxAAAAAElFTkSuQmCC",
    "displayName": "",
    "id": "brand_dummy"
  },
  "containerContexts": [
    "WEB"
  ]
}

___TEMPLATE_PARAMETERS___

[
  {
    "name": "type",
    "macrosInSelect": false,
    "selectItems": [
      {
        "displayValue": "Beacon",
        "value": "beacon"
      },
      {
        "displayValue": "Context - Product",
        "value": "productContext"
      },
      {
        "displayValue": "Event - Add to Cart",
        "value": "a2c"
      },
      {
        "displayValue": "Event - Order Confirm",
        "value": "orderConfirm"
      },
      {
        "displayValue": "Event - Status Cart",
        "value": "statusCart"
      },
      {
        "displayValue": "Event - User Login",
        "value": "userLogin"
      }
    ],
    "displayName": "Tag Type",
    "defaultValue": "beacon",
    "simpleValueType": true,
    "type": "SELECT"
  },
  {
    "name": "ckey",
    "help": "Customer Key can be found under Developer Resources tab in CEC",
    "displayName": "Customer Key",
    "simpleValueType": true,
    "type": "TEXT",
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      }
    ],
    "enablingConditions": [
      {
        "paramName": "type",
        "paramValue": "beacon",
        "type": "EQUALS"
      }
    ]
  },
  {
    "name": "env",
    "macrosInSelect": false,
    "selectItems": [
      {
        "displayValue": "Development",
        "value": "uat"
      },
      {
        "displayValue": "Production",
        "value": "prod"
      }
    ],
    "displayName": "Environment",
    "defaultValue": "prod",
    "simpleValueType": true,
    "type": "SELECT",
    "enablingConditions": [
      {
        "paramName": "type",
        "paramValue": "beacon",
        "type": "EQUALS"
      }
    ]
  },
  {
    "name": "customBeaconUrl",
    "help": "Be sure to allow this URL in the Inject Scripts Permissions. Go to the Template Editor, open the Permissions tab and add the URL as a new line in \"Inject Scripts\" section.",
    "displayName": "Custom URL",
    "simpleValueType": true,
    "type": "TEXT",
    "enablingConditions": [
      {
        "paramName": "type",
        "paramValue": "beacon",
        "type": "EQUALS"
      }
    ]
  },
  {
    "name": "rfkids",
    "help": "Comma separated rfkids. Products Context will be applied to all Reflektion widgets in the page if nothing is specified here. See Reflektion Widget Context Technical Guide for details. (Comma separated rfkids entered here will be converted into a list of rfkids)",
    "displayName": "rfkids",
    "simpleValueType": true,
    "type": "TEXT",
    "enablingConditions": [
      {
        "paramName": "type",
        "paramValue": "productContext",
        "type": "EQUALS"
      }
    ]
  },
  {
    "name": "skuList",
    "help": "List of product SKUs. See Reflektion Widget Context Technical Guide for details",
    "displayName": "SKU List",
    "simpleValueType": true,
    "type": "TEXT",
    "enablingConditions": [
      {
        "paramName": "type",
        "paramValue": "productContext",
        "type": "EQUALS"
      }
    ]
  },
  {
    "name": "pageName",
    "help": "Used in Add To Cart events. Examples: pdp, home, category, cart, qview",
    "displayName": "Page Name",
    "simpleValueType": true,
    "type": "SELECT",
    "selectItems": [
      {
        "displayValue": "Product Details Page",
        "value": "pdp"
      },
      {
        "displayValue": "Home",
        "value": "home"
      },
      {
        "displayValue": "Cart",
        "value": "cart"
      },
      {
        "displayValue": "Category",
        "value": "category"
      },
      {
        "displayValue": "Quick View",
        "value": "qview"
      }
    ],
    "enablingConditions": [
      {
        "paramName": "type",
        "paramValue": "a2c",
        "type": "EQUALS"
      }
    ]
  },
  {
    "name": "productDetails",
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      }
    ],
    "valueHint": "Set a product or a list of products var",
    "simpleValueType": true,
    "type": "TEXT",
    "displayName": "Product Details",
    "enablingConditions": [
      {
        "paramName": "type",
        "paramValue": "a2c",
        "type": "EQUALS"
      },
      {
        "paramName": "type",
        "paramValue": "orderConfirm",
        "type": "EQUALS"
      },
      {
        "paramName": "type",
        "paramValue": "statusCart",
        "type": "EQUALS"
      }
    ]
  },
  {
    "name": "productMapEnabled",
    "type": "CHECKBOX",
    "checkboxText": "Map product properties",
    "simpleValueType": true,
    "enablingConditions": [
      {
        "paramName": "type",
        "paramValue": "a2c",
        "type": "EQUALS"
      },
      {
        "paramName": "type",
        "paramValue": "orderConfirm",
        "type": "EQUALS"
      },
      {
        "paramName": "type",
        "paramValue": "statusCart",
        "type": "EQUALS"
      }
    ]
  },
  {
    "displayName": "sku",
    "name": "productSkuGroup",
    "groupStyle": "ZIPPY_OPEN_ON_PARAM",
    "type": "GROUP",
    "enablingConditions": [
      {
        "paramName": "productMapEnabled",
        "paramValue": true,
        "type": "EQUALS"
      }
    ],
    "subParams": [
      {
        "type": "RADIO",
        "name": "productSkuType",
        "radioItems": [
          {
            "value": "auto",
            "displayValue": "Automatically map property with same name"
          },
          {
            "value": "prop",
            "displayValue": "Product property"
          },
          {
            "value": "var",
            "displayValue": "Data Layer Variable"
          }
        ],
        "simpleValueType": true,
        "defaultValue": "auto"
      },
      {
        "simpleValueType": true,
        "name": "productSkuProp",
        "type": "TEXT",
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          }
        ],
        "enablingConditions": [
          {
            "paramName": "productSkuType",
            "paramValue": "prop",
            "type": "EQUALS"
          },
          {
            "paramName": "productSkuType",
            "paramValue": "var",
            "type": "EQUALS"
          }
        ]
      }
    ]
  },
  {
    "displayName": "price",
    "name": "productPriceGroup",
    "groupStyle": "ZIPPY_OPEN_ON_PARAM",
    "type": "GROUP",
    "enablingConditions": [
      {
        "paramName": "productMapEnabled",
        "paramValue": true,
        "type": "EQUALS"
      }
    ],
    "subParams": [
      {
        "type": "RADIO",
        "name": "productPriceType",
        "radioItems": [
          {
            "value": "auto",
            "displayValue": "Automatically map property with same name"
          },
          {
            "value": "prop",
            "displayValue": "Product property"
          },
          {
            "value": "var",
            "displayValue": "Data Layer Variable"
          }
        ],
        "simpleValueType": true,
        "defaultValue": "auto"
      },
      {
        "simpleValueType": true,
        "name": "productPriceProp",
        "type": "TEXT",
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          }
        ],
        "enablingConditions": [
          {
            "paramName": "productPriceType",
            "paramValue": "prop",
            "type": "EQUALS"
          },
          {
            "paramName": "productPriceType",
            "paramValue": "var",
            "type": "EQUALS"
          }
        ]
      }
    ]
  },
  {
    "displayName": "quantity",
    "name": "productQuantityGroup",
    "groupStyle": "ZIPPY_OPEN_ON_PARAM",
    "type": "GROUP",
    "enablingConditions": [
      {
        "paramName": "productMapEnabled",
        "paramValue": true,
        "type": "EQUALS"
      }
    ],
    "subParams": [
      {
        "type": "RADIO",
        "name": "productQuantityType",
        "radioItems": [
          {
            "value": "auto",
            "displayValue": "Automatically map property with same name"
          },
          {
            "value": "prop",
            "displayValue": "Product property"
          },
          {
            "value": "var",
            "displayValue": "Data Layer Variable"
          }
        ],
        "simpleValueType": true,
        "defaultValue": "auto"
      },
      {
        "simpleValueType": true,
        "name": "productQuantityProp",
        "type": "TEXT",
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          }
        ],
        "enablingConditions": [
          {
            "paramName": "productQuantityType",
            "paramValue": "prop",
            "type": "EQUALS"
          },
          {
            "paramName": "productQuantityType",
            "paramValue": "var",
            "type": "EQUALS"
          }
        ]
      }
    ]
  },
  {
    "displayName": "fitments",
    "name": "productFitmentsGroup",
    "groupStyle": "ZIPPY_OPEN_ON_PARAM",
    "type": "GROUP",
    "enablingConditions": [
      {
        "paramName": "productMapEnabled",
        "paramValue": true,
        "type": "EQUALS"
      }
    ],
    "subParams": [
      {
        "type": "RADIO",
        "name": "productFitmentsType",
        "radioItems": [
          {
            "value": "auto",
            "displayValue": "Automatically map property with same name"
          },
          {
            "value": "prop",
            "displayValue": "Product property"
          },
          {
            "value": "var",
            "displayValue": "Data Layer Variable"
          }
        ],
        "simpleValueType": true,
        "defaultValue": "auto"
      },
      {
        "simpleValueType": true,
        "name": "productFitmentsProp",
        "type": "TEXT",
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          }
        ],
        "enablingConditions": [
          {
            "paramName": "productFitmentsType",
            "paramValue": "prop",
            "type": "EQUALS"
          },
          {
            "paramName": "productFitmentsType",
            "paramValue": "var",
            "type": "EQUALS"
          }
        ]
      },
      {
        "name": "productFitmentsMapEnabled",
        "type": "CHECKBOX",
        "checkboxText": "Map fitments properties",
        "simpleValueType": true,
        "enablingConditions": []
      },
      {
        "displayName": "year",
        "name": "productFitmentsYearGroup",
        "groupStyle": "ZIPPY_OPEN_ON_PARAM",
        "type": "GROUP",
        "enablingConditions": [
          {
            "paramName": "productFitmentsMapEnabled",
            "paramValue": true,
            "type": "EQUALS"
          }
        ],
        "subParams": [
          {
            "type": "RADIO",
            "name": "productFitmentsYearType",
            "radioItems": [
              {
                "value": "auto",
                "displayValue": "Automatically map property with same name"
              },
              {
                "value": "prop",
                "displayValue": "Fitments property"
              },
              {
                "value": "var",
                "displayValue": "Data Layer Variable"
              }
            ],
            "simpleValueType": true,
            "defaultValue": "auto"
          },
          {
            "simpleValueType": true,
            "name": "productFitmentsYearProp",
            "type": "TEXT",
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ],
            "enablingConditions": [
              {
                "paramName": "productFitmentsYearType",
                "paramValue": "prop",
                "type": "EQUALS"
              },
              {
                "paramName": "productFitmentsYearType",
                "paramValue": "var",
                "type": "EQUALS"
              }
            ]
          }
        ]
      },
      {
        "displayName": "model",
        "name": "productFitmentsModelGroup",
        "groupStyle": "ZIPPY_OPEN_ON_PARAM",
        "type": "GROUP",
        "enablingConditions": [
          {
            "paramName": "productFitmentsMapEnabled",
            "paramValue": true,
            "type": "EQUALS"
          }
        ],
        "subParams": [
          {
            "type": "RADIO",
            "name": "productFitmentsModelType",
            "radioItems": [
              {
                "value": "auto",
                "displayValue": "Automatically map property with same name"
              },
              {
                "value": "prop",
                "displayValue": "Fitments property"
              },
              {
                "value": "var",
                "displayValue": "Data Layer Variable"
              }
            ],
            "simpleValueType": true,
            "defaultValue": "auto"
          },
          {
            "simpleValueType": true,
            "name": "productFitmentsModelProp",
            "type": "TEXT",
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ],
            "enablingConditions": [
              {
                "paramName": "productFitmentsModelType",
                "paramValue": "prop",
                "type": "EQUALS"
              },
              {
                "paramName": "productFitmentsModelType",
                "paramValue": "var",
                "type": "EQUALS"
              }
            ]
          }
        ]
      },
      {
        "displayName": "make",
        "name": "productFitmentsMakeGroup",
        "groupStyle": "ZIPPY_OPEN_ON_PARAM",
        "type": "GROUP",
        "enablingConditions": [
          {
            "paramName": "productFitmentsMapEnabled",
            "paramValue": true,
            "type": "EQUALS"
          }
        ],
        "subParams": [
          {
            "type": "RADIO",
            "name": "productFitmentsMakeType",
            "radioItems": [
              {
                "value": "auto",
                "displayValue": "Automatically map property with same name"
              },
              {
                "value": "prop",
                "displayValue": "Fitments property"
              },
              {
                "value": "var",
                "displayValue": "Data Layer Variable"
              }
            ],
            "simpleValueType": true,
            "defaultValue": "auto"
          },
          {
            "simpleValueType": true,
            "name": "productFitmentsMakeProp",
            "type": "TEXT",
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ],
            "enablingConditions": [
              {
                "paramName": "productFitmentsMakeType",
                "paramValue": "prop",
                "type": "EQUALS"
              },
              {
                "paramName": "productFitmentsMakeType",
                "paramValue": "var",
                "type": "EQUALS"
              }
            ]
          }
        ]
      },
      {
        "displayName": "fit_type",
        "name": "productFitmentsFitTypeGroup",
        "groupStyle": "ZIPPY_OPEN_ON_PARAM",
        "type": "GROUP",
        "enablingConditions": [
          {
            "paramName": "productFitmentsMapEnabled",
            "paramValue": true,
            "type": "EQUALS"
          }
        ],
        "subParams": [
          {
            "type": "RADIO",
            "name": "productFitmentsFitTypeType",
            "radioItems": [
              {
                "value": "auto",
                "displayValue": "Automatically map property with same name"
              },
              {
                "value": "prop",
                "displayValue": "Fitments property"
              },
              {
                "value": "var",
                "displayValue": "Data Layer Variable"
              }
            ],
            "simpleValueType": true,
            "defaultValue": "auto"
          },
          {
            "simpleValueType": true,
            "name": "productFitmentsFitTypeProp",
            "type": "TEXT",
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ],
            "enablingConditions": [
              {
                "paramName": "productFitmentsFitTypeType",
                "paramValue": "prop",
                "type": "EQUALS"
              },
              {
                "paramName": "productFitmentsFitTypeType",
                "paramValue": "var",
                "type": "EQUALS"
              }
            ]
          }
        ]
      }
    ]
  },
  {
    "name": "checkoutDetails",
    "valueHint": "Select a checkout object",
    "simpleValueType": true,
    "type": "TEXT",
    "help": "Checkout Object. See Reflektion Events API documentation for details. You can map the checkout details selecting a checkout object below checking the \"Map checkout properties\" checkbox.",
    "displayName": "Checkout Details",
    "enablingConditions": [
      {
        "paramName": "type",
        "paramValue": "a2c",
        "type": "EQUALS"
      },
      {
        "paramName": "type",
        "paramValue": "orderConfirm",
        "type": "EQUALS"
      }
    ]
  },
  {
    "name": "checkoutMapEnabled",
    "type": "CHECKBOX",
    "checkboxText": "Map checkout properties",
    "simpleValueType": true,
    "enablingConditions": [
      {
        "paramName": "type",
        "paramValue": "a2c",
        "type": "EQUALS"
      },
      {
        "paramName": "type",
        "paramValue": "orderConfirm",
        "type": "EQUALS"
      }
    ]
  },
  {
    "displayName": "total",
    "name": "checkoutTotalGroup",
    "groupStyle": "ZIPPY_OPEN_ON_PARAM",
    "type": "GROUP",
    "enablingConditions": [
      {
        "paramName": "checkoutMapEnabled",
        "paramValue": true,
        "type": "EQUALS"
      }
    ],
    "subParams": [
      {
        "type": "RADIO",
        "name": "checkoutTotalType",
        "radioItems": [
          {
            "value": "auto",
            "displayValue": "Automatically map property with same name"
          },
          {
            "value": "prop",
            "displayValue": "Checkout property"
          },
          {
            "value": "var",
            "displayValue": "Data Layer Variable"
          }
        ],
        "simpleValueType": true,
        "defaultValue": "auto"
      },
      {
        "simpleValueType": true,
        "name": "checkoutTotalProp",
        "type": "TEXT",
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          }
        ],
        "enablingConditions": [
          {
            "paramName": "checkoutTotalType",
            "paramValue": "prop",
            "type": "EQUALS"
          },
          {
            "paramName": "checkoutTotalType",
            "paramValue": "var",
            "type": "EQUALS"
          }
        ]
      }
    ]
  },
  {
    "displayName": "subtotal",
    "name": "checkoutSubtotalGroup",
    "groupStyle": "ZIPPY_OPEN_ON_PARAM",
    "type": "GROUP",
    "enablingConditions": [
      {
        "paramName": "checkoutMapEnabled",
        "paramValue": true,
        "type": "EQUALS"
      }
    ],
    "subParams": [
      {
        "type": "RADIO",
        "name": "checkoutSubtotalType",
        "radioItems": [
          {
            "value": "auto",
            "displayValue": "Automatically map property with same name"
          },
          {
            "value": "prop",
            "displayValue": "Checkout property"
          },
          {
            "value": "var",
            "displayValue": "Data Layer Variable"
          }
        ],
        "simpleValueType": true,
        "defaultValue": "auto"
      },
      {
        "simpleValueType": true,
        "name": "checkoutSubtotalProp",
        "type": "TEXT",
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          }
        ],
        "enablingConditions": [
          {
            "paramName": "checkoutSubtotalType",
            "paramValue": "prop",
            "type": "EQUALS"
          },
          {
            "paramName": "checkoutSubtotalType",
            "paramValue": "var",
            "type": "EQUALS"
          }
        ]
      }
    ]
  },
  {
    "displayName": "order_id",
    "name": "checkoutOrderIdGroup",
    "groupStyle": "ZIPPY_OPEN_ON_PARAM",
    "type": "GROUP",
    "enablingConditions": [
      {
        "paramName": "checkoutMapEnabled",
        "paramValue": true,
        "type": "EQUALS"
      }
    ],
    "subParams": [
      {
        "type": "RADIO",
        "name": "checkoutOrderIdType",
        "radioItems": [
          {
            "value": "auto",
            "displayValue": "Automatically map property with same name"
          },
          {
            "value": "prop",
            "displayValue": "Checkout property"
          },
          {
            "value": "var",
            "displayValue": "Data Layer Variable"
          }
        ],
        "simpleValueType": true,
        "defaultValue": "auto"
      },
      {
        "simpleValueType": true,
        "name": "checkoutOrderIdProp",
        "type": "TEXT",
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          }
        ],
        "enablingConditions": [
          {
            "paramName": "checkoutOrderIdType",
            "paramValue": "prop",
            "type": "EQUALS"
          },
          {
            "paramName": "checkoutOrderIdType",
            "paramValue": "var",
            "type": "EQUALS"
          }
        ]
      }
    ]
  },
  {
    "name": "userDetails",
    "valueHint": "Select a user object",
    "simpleValueType": true,
    "type": "TEXT",
    "help": "User Object. See Reflektion Events API documentation for details. You can map the user details selecting a user object below checking the \"Map user properties\" checkbox.",
    "displayName": "User Details",
    "enablingConditions": [
      {
        "paramName": "type",
        "paramValue": "a2c",
        "type": "EQUALS"
      },
      {
        "paramName": "type",
        "paramValue": "userLogin",
        "type": "EQUALS"
      },
      {
        "paramName": "type",
        "paramValue": "orderConfirm",
        "type": "EQUALS"
      }
    ]
  },
  {
    "name": "userMapEnabled",
    "type": "CHECKBOX",
    "checkboxText": "Map user properties",
    "simpleValueType": true,
    "enablingConditions": [
      {
        "paramName": "type",
        "paramValue": "a2c",
        "type": "EQUALS"
      },
      {
        "paramName": "type",
        "paramValue": "userLogin",
        "type": "EQUALS"
      },
      {
        "paramName": "type",
        "paramValue": "orderConfirm",
        "type": "EQUALS"
      }
    ]
  },
  {
    "displayName": "id",
    "name": "userIdGroup",
    "groupStyle": "ZIPPY_OPEN_ON_PARAM",
    "type": "GROUP",
    "enablingConditions": [
      {
        "paramName": "userMapEnabled",
        "paramValue": true,
        "type": "EQUALS"
      }
    ],
    "subParams": [
      {
        "type": "RADIO",
        "name": "userIdType",
        "radioItems": [
          {
            "value": "auto",
            "displayValue": "Automatically map property with same name"
          },
          {
            "value": "prop",
            "displayValue": "User property"
          },
          {
            "value": "var",
            "displayValue": "Data Layer Variable"
          }
        ],
        "simpleValueType": true,
        "defaultValue": "auto"
      },
      {
        "simpleValueType": true,
        "name": "userIdProp",
        "type": "TEXT",
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          }
        ],
        "enablingConditions": [
          {
            "paramName": "userIdType",
            "paramValue": "prop",
            "type": "EQUALS"
          },
          {
            "paramName": "userIdType",
            "paramValue": "var",
            "type": "EQUALS"
          }
        ]
      }
    ]
  },
  {
    "displayName": "eid",
    "name": "userEidGroup",
    "groupStyle": "ZIPPY_OPEN_ON_PARAM",
    "type": "GROUP",
    "enablingConditions": [
      {
        "paramName": "userMapEnabled",
        "paramValue": true,
        "type": "EQUALS"
      }
    ],
    "subParams": [
      {
        "type": "RADIO",
        "name": "userEidType",
        "radioItems": [
          {
            "value": "auto",
            "displayValue": "Automatically map property with same name"
          },
          {
            "value": "prop",
            "displayValue": "User property"
          },
          {
            "value": "var",
            "displayValue": "Data Layer Variable"
          }
        ],
        "simpleValueType": true,
        "defaultValue": "auto"
      },
      {
        "simpleValueType": true,
        "name": "userEidProp",
        "type": "TEXT",
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          }
        ],
        "enablingConditions": [
          {
            "paramName": "userEidType",
            "paramValue": "prop",
            "type": "EQUALS"
          },
          {
            "paramName": "userEidType",
            "paramValue": "var",
            "type": "EQUALS"
          }
        ]
      }
    ]
  },
  {
    "displayName": "fbid",
    "name": "userFbidGroup",
    "groupStyle": "ZIPPY_OPEN_ON_PARAM",
    "type": "GROUP",
    "enablingConditions": [
      {
        "paramName": "userMapEnabled",
        "paramValue": true,
        "type": "EQUALS"
      }
    ],
    "subParams": [
      {
        "type": "RADIO",
        "name": "userFbidType",
        "radioItems": [
          {
            "value": "auto",
            "displayValue": "Automatically map property with same name"
          },
          {
            "value": "prop",
            "displayValue": "User property"
          },
          {
            "value": "var",
            "displayValue": "Data Layer Variable"
          }
        ],
        "simpleValueType": true,
        "defaultValue": "auto"
      },
      {
        "simpleValueType": true,
        "name": "userFbidProp",
        "type": "TEXT",
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          }
        ],
        "enablingConditions": [
          {
            "paramName": "userFbidType",
            "paramValue": "prop",
            "type": "EQUALS"
          },
          {
            "paramName": "userFbidType",
            "paramValue": "var",
            "type": "EQUALS"
          }
        ]
      }
    ]
  },
  {
    "displayName": "email",
    "name": "userEmailGroup",
    "groupStyle": "ZIPPY_OPEN_ON_PARAM",
    "type": "GROUP",
    "enablingConditions": [
      {
        "paramName": "userMapEnabled",
        "paramValue": true,
        "type": "EQUALS"
      }
    ],
    "subParams": [
      {
        "type": "RADIO",
        "name": "userEmailType",
        "radioItems": [
          {
            "value": "auto",
            "displayValue": "Automatically map property with same name"
          },
          {
            "value": "prop",
            "displayValue": "User property"
          },
          {
            "value": "var",
            "displayValue": "Data Layer Variable"
          }
        ],
        "simpleValueType": true,
        "defaultValue": "auto"
      },
      {
        "simpleValueType": true,
        "name": "userEmailProp",
        "type": "TEXT",
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          }
        ],
        "enablingConditions": [
          {
            "paramName": "userEmailType",
            "paramValue": "prop",
            "type": "EQUALS"
          },
          {
            "paramName": "userEmailType",
            "paramValue": "var",
            "type": "EQUALS"
          }
        ]
      }
    ]
  },
  {
    "displayName": "cmid",
    "name": "userCmidGroup",
    "groupStyle": "ZIPPY_OPEN_ON_PARAM",
    "type": "GROUP",
    "enablingConditions": [
      {
        "paramName": "userMapEnabled",
        "paramValue": true,
        "type": "EQUALS"
      }
    ],
    "subParams": [
      {
        "type": "RADIO",
        "name": "userCmidType",
        "radioItems": [
          {
            "value": "auto",
            "displayValue": "Automatically map property with same name"
          },
          {
            "value": "prop",
            "displayValue": "User property"
          },
          {
            "value": "var",
            "displayValue": "Data Layer Variable"
          }
        ],
        "simpleValueType": true,
        "defaultValue": "auto"
      },
      {
        "simpleValueType": true,
        "name": "userCmidProp",
        "type": "TEXT",
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          }
        ],
        "enablingConditions": [
          {
            "paramName": "userCmidType",
            "paramValue": "prop",
            "type": "EQUALS"
          },
          {
            "paramName": "userCmidType",
            "paramValue": "var",
            "type": "EQUALS"
          }
        ]
      }
    ]
  },
  {
    "displayName": "rpid",
    "name": "userRpidGroup",
    "groupStyle": "ZIPPY_OPEN_ON_PARAM",
    "type": "GROUP",
    "enablingConditions": [
      {
        "paramName": "userMapEnabled",
        "paramValue": true,
        "type": "EQUALS"
      }
    ],
    "subParams": [
      {
        "type": "RADIO",
        "name": "userRpidType",
        "radioItems": [
          {
            "value": "auto",
            "displayValue": "Automatically map property with same name"
          },
          {
            "value": "prop",
            "displayValue": "User property"
          },
          {
            "value": "var",
            "displayValue": "Data Layer Variable"
          }
        ],
        "simpleValueType": true,
        "defaultValue": "auto"
      },
      {
        "simpleValueType": true,
        "name": "userRpidProp",
        "type": "TEXT",
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          }
        ],
        "enablingConditions": [
          {
            "paramName": "userRpidType",
            "paramValue": "prop",
            "type": "EQUALS"
          },
          {
            "paramName": "userRpidType",
            "paramValue": "var",
            "type": "EQUALS"
          }
        ]
      }
    ]
  },
  {
    "displayName": "first_name",
    "name": "userFirstNameGroup",
    "groupStyle": "ZIPPY_OPEN_ON_PARAM",
    "type": "GROUP",
    "enablingConditions": [
      {
        "paramName": "userMapEnabled",
        "paramValue": true,
        "type": "EQUALS"
      }
    ],
    "subParams": [
      {
        "type": "RADIO",
        "name": "userFirstNameType",
        "radioItems": [
          {
            "value": "auto",
            "displayValue": "Automatically map property with same name"
          },
          {
            "value": "prop",
            "displayValue": "User property"
          },
          {
            "value": "var",
            "displayValue": "Data Layer Variable"
          }
        ],
        "simpleValueType": true,
        "defaultValue": "auto"
      },
      {
        "simpleValueType": true,
        "name": "userFirstNameProp",
        "type": "TEXT",
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          }
        ],
        "enablingConditions": [
          {
            "paramName": "userFirstNameType",
            "paramValue": "prop",
            "type": "EQUALS"
          },
          {
            "paramName": "userFirstNameType",
            "paramValue": "var",
            "type": "EQUALS"
          }
        ]
      }
    ]
  },
  {
    "displayName": "last_name",
    "name": "userLastNameGroup",
    "groupStyle": "ZIPPY_OPEN_ON_PARAM",
    "type": "GROUP",
    "enablingConditions": [
      {
        "paramName": "userMapEnabled",
        "paramValue": true,
        "type": "EQUALS"
      }
    ],
    "subParams": [
      {
        "type": "RADIO",
        "name": "userLastNameType",
        "radioItems": [
          {
            "value": "auto",
            "displayValue": "Automatically map property with same name"
          },
          {
            "value": "prop",
            "displayValue": "User property"
          },
          {
            "value": "var",
            "displayValue": "Data Layer Variable"
          }
        ],
        "simpleValueType": true,
        "defaultValue": "auto"
      },
      {
        "simpleValueType": true,
        "name": "userLastNameProp",
        "type": "TEXT",
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          }
        ],
        "enablingConditions": [
          {
            "paramName": "userLastNameType",
            "paramValue": "prop",
            "type": "EQUALS"
          },
          {
            "paramName": "userLastNameType",
            "paramValue": "var",
            "type": "EQUALS"
          }
        ]
      }
    ]
  },
  {
    "displayName": "Other properties",
    "name": "userCustomGroup",
    "groupStyle": "ZIPPY_OPEN_ON_PARAM",
    "type": "GROUP",
    "enablingConditions": [
      {
        "paramName": "userMapEnabled",
        "paramValue": true,
        "type": "EQUALS"
      }
    ],
    "subParams": [
      {
        "type": "PARAM_TABLE",
        "name": "userCustom",
        "enablingConditions": [
          {
            "paramName": "userMapEnabled",
            "paramValue": true,
            "type": "EQUALS"
          }
        ],
        "paramTableColumns": [
          {
            "param": {
              "type": "SELECT",
              "name": "key",
              "displayName": "Property",
              "selectItems": [
                {
                  "value": "address",
                  "displayValue": "address"
                },
                {
                  "value": "attributes",
                  "displayValue": "attributes"
                }
              ],
              "simpleValueType": true
            },
            "isUnique": true
          },
          {
            "param": {
              "type": "SELECT",
              "name": "type",
              "displayName": "Mapping Type",
              "selectItems": [
                {
                  "value": "auto",
                  "displayValue": "Automatically map property with same name"
                },
                {
                  "value": "prop",
                  "displayValue": "User property"
                },
                {
                  "value": "var",
                  "displayValue": "Data Layer Variable"
                }
              ],
              "simpleValueType": true,
              "macrosInSelect": false
            },
            "isUnique": false
          },
          {
            "param": {
              "type": "TEXT",
              "name": "prop",
              "displayName": "Mapping Value",
              "simpleValueType": true
            },
            "isUnique": false
          }
        ],
        "editRowTitle": "Edit Property",
        "newRowButtonText": "New Property",
        "newRowTitle": "New Property"
      }
    ]
  }
]

___WEB_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "debug"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "inject_script",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://*.rfksrv.com/*"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_globals",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keys",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "rfk"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]

___SANDBOXED_JS_FOR_WEB_TEMPLATE___

const PROPERTIES = {
  "productDetails": {
    "varName": "product",
    "type": "list",
    "children": [
      {
        "id": "sku",
        "varName": "productSku"
      },
      {
        "id": "price",
        "varName": "productPrice"
      },
      {
        "id": "quantity",
        "varName": "productQuantity"
      },
      {
        "id": "fitments",
        "varName": "productFitments",
        "type": "list",
        "options": {
          "allowEmpty": false
        },
        "children": [
          {
            "id": "year",
            "varName": "productFitmentsYear"
          },
          {
            "id": "model",
            "varName": "productFitmentsModel"
          },
          {
            "id": "make",
            "varName": "productFitmentsMake"
          },
          {
            "id": "fit_type",
            "varName": "productFitmentsFitType"
          }
        ]
      }
    ]
  },
  "checkoutDetails": {
    "varName": "checkout",
    "type": "object",
    "children": [
      {
        "id": "total",
        "varName": "checkoutTotal"
      },
      {
        "id": "subtotal",
        "varName": "checkoutSubtotal"
      },
      {
        "id": "order_id",
        "varName": "checkoutOrderId"
      }
    ]
  },
  "userDetails": {
    "varName": "user",
    "type": "object",
    "children": [
      {
        "id": "id",
        "varName": "userId"
      },
      {
        "id": "email",
        "varName": "userEmail"
      },
      {
        "id": "eid",
        "varName": "userEid"
      },
      {
        "id": "fbid",
        "varName": "userFbid"
      },
      {
        "id": "cmid",
        "varName": "userCmid"
      },
      {
        "id": "rpid",
        "varName": "userRpid"
      },
      {
        "id": "first_name",
        "varName": "userFirstName"
      },
      {
        "id": "last_name",
        "varName": "userLastName"
      },
      {
        "varName": "userCustom",
        "type": "key-value"
      }
    ]
  }
};
const log = require('logToConsole');

/**
 * Gets a param from data layer
 * @param {string} key - Key param
 * @returns {*}
 */
function getParam(key) {
  return data[key];
}

/**
 * Builds a mapping value
 * @param {object} obj - Object to build the value from
 * @param {string} key - Map key
 * @param {string} type - Value map type
 * @param {string} prop - Value map prop
 * @returns {*}
 */
function buildValue(obj, key, type, prop) {
  let value;
  if (type === 'var') {
    // in case it was mapped to a data layer variable
    value = prop;
  } else if (type === 'prop' && obj.hasOwnProperty(prop)) {
    // in case it was mapped to a object prop
    value = obj[prop];
  } else {
    // in case it was mapped automatically
    value = obj[key];
  }

  if (typeof value !== 'undefined') {
    return value;
  }
  return undefined;
}

/**
 * Maps an object based on template configuration
 * @param {object} obj - Object to map
 * @param {object[]} mappedProps - Map of mapped key and props
 * @param {object[]} properties - List of properties to auto map
 * @param {boolean} mappingEnabled - Mapping enabled flag to determine if obj needs to be mapped
 * @returns {object}
 */
function mapObject(obj, mappedProps, properties, mappingEnabled) {
  if (!mappingEnabled) {
    return obj;
  }

  obj = obj || {};

  const result = {};
  let hasKeys = false;

  mappedProps.forEach(function (mapped) {
    let value;
    if (mapped.type === 'key-value') {
      value = mapObject(obj, mapped.value, properties, true);
    } else {
      value = buildValue(obj, mapped.key, mapped.type, mapped.prop);
    }

    if (typeof value !== 'undefined') {
      hasKeys = true;
      if (mapped.mappingEnabled) {
        value = mapVar(value, mapped.config);
      }
      if (mapped.merge) {
        for (let key in value) {
          result[key] = value[key];
        }
      } else {
        result[mapped.key] = value;
      }
    }
  });

  if (hasKeys) {
    return result;
  }

  return undefined;
}

/**
 * Builds a products list mapping its values based on template configuration
 * @param {object[]} objects - objects list to map
 * @param {object[]} mappedProps - map containing the props that will be mapped
 * @param {object[]} properties - all the available props to be mapped
 * @param {boolean} mappingEnabled - Mapping enabled flag to determine if obj needs to be mapped
 * @returns {Array}
 */
function buildList(objects, mappedProps, properties, mappingEnabled) {
  return objects
    .map(function (obj) {
      return mapObject(obj, mappedProps, properties, mappingEnabled);
    })
    .filter(function (item) {
      return !!item;
    });
}

/**
 * Generates the configuration of a specified property to be mapped
 * @param {object} property - property to generate the configuration to be mapped
 * @returns {{type: *, config: ({children}|*), value: (*|*[]), key: *}|{mappingEnabled: boolean, prop: *, type: *, config: ({children}|*), key: *}}
 */
function getMappedProp(property) {
  const key = property.id;
  const varName = property.varName;
  const children = property.children || [];

  if (property.type === 'key-value') {
    const value = getParam(varName);
    if (value) {
      return {
        key: key,
        type: property.type,
        config: property,
        value: getParam(varName),
        merge: true,
      };
    }
  }

  return {
    key: key,
    type: getParam(varName + 'Type'),
    prop: getParam(varName + 'Prop'),
    mappingEnabled: children.length > 0,
    config: property,
  };
}

/**
 * Generates a list of properties to be mapped
 * @param {Array} properties - Object to get the mapped props from
 * @returns {Array}
 */
function getMappedProps(properties) {
  return properties.map(getMappedProp);
}

/**
 * Maps a products list
 * @param {object} obj - Object to map its properties
 * @param {object} config - Configuration to use for mapping obj properties
 * @param {boolean} mappingEnabled - Mapping enabled flag to determine if obj needs to be mapped
 * @returns {object}
 */
function mapItem(obj, config, mappingEnabled) {
  return mapObject(
    obj,
    getMappedProps(config.children),
    config.children,
    mappingEnabled
  );
}

/**
 * Maps a products list
 * @param {object[]|{}} obj - List of products to map
 * @param {object} config - Configuration to use for mapping obj properties
 * @param {boolean} mappingEnabled - Mapping enabled flag to determine if obj needs to be mapped
 * @returns {Array}
 */
function mapItems(obj, config, mappingEnabled) {
  if (typeof obj === 'object' && obj.length >= 0) {
    return buildList(
      obj,
      getMappedProps(config.children),
      config.children,
      mappingEnabled
    );
  }

  const result = mapItem(obj, config, mappingEnabled);
  if (result) {
    return [result];
  }
  if (config.options && !config.options.allowEmpty) {
    return undefined;
  }
  return [];
}

/**
 * Maps an object properties based on a configuration
 * @param {object|object[]} obj - Object to map its properties
 * @param {object} config - Configuration used to map the obj properties
 * @returns {null|Array|object}
 */
function mapVar(obj, config) {
  if (!config) {
    return obj;
  }

  const mappingEnabled = getParam(config.varName + 'MapEnabled');

  if (config.type === 'list') {
    obj = obj || [];
    return mapItems(obj, config, mappingEnabled);
  }

  if (config.type === 'object') {
    return mapItem(obj, config, mappingEnabled);
  }

  return null;
}

/**
 * Injects Reflektion's beacon
 * @param {object} data - Tag data information
 */
function insertBeacon(data) {
  let query = require('queryPermission'),
    injectScript = require('injectScript'),
    customUrl = data.customBeaconUrl,
    beaconUrlMap = {
      uat: 'https://initjs.uat.rfksrv.com/rfk/js/{ckey}/init.js',
      prod: 'https://{dh}-prod.rfksrv.com/rfk/js/{ckey}/init.js',
    },
    ckey = (data.ckey || '').split(' ').join(''),
    dh = ckey.split('-')[1],
    beaconUrl,
    errMsg;

  if (customUrl) {
    beaconUrl = customUrl;
  } else if (ckey && dh && data.env) {
    beaconUrl = beaconUrlMap[data.env]
      .replace('{dh}', dh)
      .replace('{ckey}', ckey);
  } else {
    errMsg = 'Invalid Customer Key';
  }

  if (beaconUrl) {
    if (query('inject_script', beaconUrl)) {
      injectScript(beaconUrl, data.gtmOnSuccess, data.gtmOnFailure);
      log(beaconUrl);
    } else {
      errMsg = 'Failed to load init.js due to URL permissions';
    }
  }

  if (errMsg) {
    log(errMsg);
    data.gtmOnFailure();
  }
}

/**
 * Updates Reflektion's product context
 * @param {object} data - Tag data information
 */
function updateProductContext(data) {
  let createQueue = require('createQueue'),
    skuList = data.skuList,
    rfkids = (data.rfkids || '').split(' ').join(''),
    context,
    rfkPush;
  if (skuList && skuList.length) {
    context = { context: { page: { sku: skuList } } };
    if (rfkids && rfkids.length) {
      if (typeof rfkids == 'string') rfkids = rfkids.split(',');
      context.widget = { rfkids: rfkids };
    }
    rfkPush = createQueue('rfk');
    log('productContext', context);
    rfkPush(['updateContext', context]);
    data.gtmOnSuccess();
  } else {
    log('Invalid SKU List');
    data.gtmOnFailure();
  }
}

/**
 * Pushes a Reflektion event
 * @param {object} data - Tag data information
 */
function pushEvent(data) {
  let createQueue = require('createQueue'),
    errMsg = '',
    eventObject,
    rfkPush;

  switch (data.type) {
    case 'a2c': {
      const pageName = data.pageName;
      if (pageName) {
        const products = mapVar(data.productDetails, PROPERTIES.productDetails);
        if (products.length > 0) {
          eventObject = {
            type: 'a2c',
            name: pageName,
            value: {
              products: products,
            },
          };
        } else {
          errMsg = 'Invalid Products';
        }
      } else {
        errMsg = 'No Page Name specified';
      }
      break;
    }

    case 'statusCart': {
      const products = mapVar(data.productDetails, PROPERTIES.productDetails);
      if (products.length > 0) {
        eventObject = {
          type: 'status',
          name: 'cart',
          value: {
            products: products,
          },
        };
      } else {
        errMsg = 'Invalid Products';
      }
      break;
    }

    case 'orderConfirm': {
      const products = mapVar(data.productDetails, PROPERTIES.productDetails);
      if (products.length > 0) {
        const checkout = mapVar(data.checkoutDetails, PROPERTIES.checkoutDetails);
        if (checkout) {
          const user = mapVar(data.userDetails, PROPERTIES.userDetails);
          eventObject = {
            type: 'order',
            name: 'confirm',
            value: {
              user: user,
              products: products,
              checkout: checkout,
            },
          };
        } else {
          errMsg = 'Invalid Checkout Details';
        }
      } else {
        errMsg = 'Invalid Products';
      }
      break;
    }

    case 'userLogin': {
      const user = mapVar(data.userDetails, PROPERTIES.userDetails);
      if (user) {
        eventObject = {
          type: 'user',
          name: 'login',
          value: {
            user: user,
          },
        };
      } else {
        errMsg = 'Invalid User Details';
      }
      break;
    }
  }

  if (eventObject) {
    log('track', eventObject);
    rfkPush = createQueue('rfk');
    rfkPush(['trackEvent', eventObject]);
    data.gtmOnSuccess();
  } else {
    log(errMsg);
    data.gtmOnFailure();
  }
}

switch (data.type) {
  case 'beacon':
    insertBeacon(data);
    break;
  case 'productContext':
    updateProductContext(data);
    break;
  case 'statusCart':
  case 'a2c':
  case 'orderConfirm':
  case 'userLogin':
    pushEvent(data);
    break;
}

___TESTS___

scenarios:
- name: Add to cart Event - no product mapping
  code: |-
    const mockData = {
        type: 'a2c',
        pageName: 'pdp',
        productMapEnabled: false,
        productDetails: {
          sku: '123123',
          title: 'abc',
          extra: 1
        }
    };

    // Call runCode to run the template's code.
    let variableResult = runCode(mockData);

    // Verify that the variable returns a result.
    assertApi('gtmOnSuccess').wasCalled();
    assertApi('logToConsole').wasCalledWith('track', {
        type: 'a2c',
        name: 'pdp',
        value: {
            products: [
                {
                  sku: '123123',
                  title: 'abc',
                  extra: 1
                }
            ]
        }
    });
- name: Add to cart Event - maps a product object
  code: |-
    const mockData = {
        type: 'a2c',
        pageName: 'pdp',
        productMapEnabled: true,
        productSkuType: 'prop',
        productSkuProp: 'skuId',
        productQuantityType: 'prop',
        productQuantityProp: 'extra',
        productDetails: {
          skuId: '123123',
          title: 'abc',
          extra: 1
        }
    };

    // Call runCode to run the template's code.
    let variableResult = runCode(mockData);

    // Verify that the variable returns a result.
    assertApi('gtmOnSuccess').wasCalled();
    assertApi('logToConsole').wasCalledWith('track', {
        type: 'a2c',
        name: 'pdp',
        value: {
            products: [
                {
                    sku: '123123',
                    quantity: 1
                }
            ]
        }
    });
- name: Add to cart Event - maps a product object, mapping keys from data layer variables
  code: |-
    const mockData = {
        type: 'a2c',
        pageName: 'pdp',
        productMapEnabled: true,
        myProductTitle: 'My Product Title',
        productSkuType: 'prop',
        productSkuProp: 'skuId',
        // mapped to {{myProductTitle}}
        productQuantityType: 'prop',
        productQuantityProp: 'extra',
        productDetails: {
          skuId: '123123',
          title: 'My Product Title',
          extra: 1
        }
    };

    // Call runCode to run the template's code.
    let variableResult = runCode(mockData);

    // Verify that the variable returns a result.
    assertApi('gtmOnSuccess').wasCalled();
    assertApi('logToConsole').wasCalledWith('track', {
        type: 'a2c',
        name: 'pdp',
        value: {
            products: [
              {
                sku: '123123',
                quantity: 1,
              }
            ]
        }
    });
- name: maps a product object with fitments within the product
  code: |-
    const mockData = {
        type: 'a2c',
        pageName: 'pdp',
        productMapEnabled: true,
        productSkuType: 'prop',
        productSkuProp: 'skuId',
        productFitmentsMapEnabled: true,
        productFitmentsType: 'prop',
        productFitmentsProp: 'myFitments',
        productFitmentsYearProp: 'myYear',
        productFitmentsYearType: 'prop',
        productFitmentsMakeProp: 'myMake',
        productFitmentsMakeType: 'prop',
        productFitmentsModelProp: 'myModel',
        productFitmentsModelType: 'prop',
        productFitmentsFitTypeProp: 'myFitmentType',
        productFitmentsFitTypeType: 'prop',
        productDetails: {
          skuId: '123123',
          title: 'abc',
          price: 132,
          myFitments: [
            {
              myYear: 2008,
              myMake: 'My Make',
              myModel: 'My Model',
              myFitmentType: 'My Fitment Type',
            }
          ],
          extra: 1
        }
    };

    // Call runCode to run the template's code.
    let variableResult = runCode(mockData);

    // Verify that the variable returns a result.
    assertApi('gtmOnSuccess').wasCalled();
    assertApi('logToConsole').wasCalledWith('track', {
        type: 'a2c',
        name: 'pdp',
        value: {
            products: [
              {
                sku: '123123',
                price: 132,
                fitments: [
                  {
                    year: 2008,
                    model: 'My Model',
                    make: 'My Make',
                    fit_type: 'My Fitment Type'
                  }
                ]
              }
            ]
        }
    });
- name: maps a product object with fitments from a data layer variable
  code: |-
    const mockData = {
        type: 'a2c',
        pageName: 'pdp',
        productMapEnabled: true,
        productSkuType: 'prop',
        productSkuProp: 'skuId',
        productFitmentsMapEnabled: true,
        productFitmentsType: 'var',
        productFitmentsYearProp: 'myYear',
        productFitmentsYearType: 'prop',
        productFitmentsMakeProp: 'myMake',
        productFitmentsMakeType: 'prop',
        productFitmentsModelProp: 'My Other Model',
        productFitmentsModelProp: 'My Other Model',
        productFitmentsModelType: 'var',
        productFitmentsFitTypeProp: 'myFitmentType',
        productFitmentsFitTypeType: 'prop',
        // mapped from {{fitments}}
        productFitmentsProp: [
          {
            myYear: 2008,
            myMake: 'My Make',
            myModel: 'My Model',
            myFitmentType: 'My Fitment Type',
          }
        ],
        productDetails: {
          skuId: '123123',
          title: 'abc',
          price: 132,
          extra: 1
        }
    };

    // Call runCode to run the template's code.
    let variableResult = runCode(mockData);

    // Verify that the variable returns a result.
    assertApi('gtmOnSuccess').wasCalled();
    assertApi('logToConsole').wasCalledWith('track', {
        type: 'a2c',
        name: 'pdp',
        value: {
            products: [
              {
                sku: '123123',
                price: 132,
                fitments: [
                  {
                    year: 2008,
                    model: 'My Other Model',
                    make: 'My Make',
                    fit_type: 'My Fitment Type'
                  }
                ]
              }
            ]
        }
    });
- name: maps a product object with fitment object within the product
  code: |-
    const mockData = {
        type: 'a2c',
        pageName: 'pdp',
        productMapEnabled: true,
        productSkuType: 'prop',
        productSkuProp: 'skuId',
        productFitmentsMapEnabled: true,
        productFitmentsType: 'prop',
        productFitmentsProp: 'myFitment',
        productFitmentsYearProp: 'myYear',
        productFitmentsYearType: 'prop',
        productFitmentsMakeProp: 'myMake',
        productFitmentsMakeType: 'prop',
        productFitmentsModelProp: 'myModel',
        productFitmentsModelType: 'prop',
        productFitmentsFitTypeProp: 'myFitmentType',
        productFitmentsFitTypeType: 'prop',
        productDetails: {
          skuId: '123123',
          title: 'abc',
          price: 132,
          myFitment: {
              myYear: 2008,
              myMake: 'My Make',
              myModel: 'My Model',
              myFitmentType: 'My Fitment Type',
            },
          extra: 1
        }
    };

    // Call runCode to run the template's code.
    let variableResult = runCode(mockData);

    // Verify that the variable returns a result.
    assertApi('gtmOnSuccess').wasCalled();
    assertApi('logToConsole').wasCalledWith('track', {
        type: 'a2c',
        name: 'pdp',
        value: {
            products: [
              {
                sku: '123123',
                price: 132,
                fitments: [
                  {
                    year: 2008,
                    model: 'My Model',
                    make: 'My Make',
                    fit_type: 'My Fitment Type'
                  }
                ]
              }
            ]
        }
    });
- name: maps a product object with fitment object from a data layer variable
  code: |-
    const mockData = {
        type: 'a2c',
        pageName: 'pdp',
        productMapEnabled: true,
        productSkuType: 'prop',
        productSkuProp: 'skuId',
        productFitmentsYearProp: 'myYear',
        productFitmentsYearType: 'prop',
        productFitmentsMakeProp: 'myMake',
        productFitmentsMakeType: 'prop',
        productFitmentsModelProp: 'myModel',
        productFitmentsModelType: 'prop',
        productFitmentsFitTypeProp: 'myFitmentType',
        productFitmentsFitTypeType: 'prop',
        fitment: {
            myYear: 2008,
            myMake: 'My Make',
            myModel: 'My Model',
            myFitmentType: 'My Fitment Type',
          },
        // mapped from {{fitment}}
        productFitmentsMapEnabled: true,
        productFitmentsType: 'var',
        productFitmentsProp: {
            myYear: 2008,
            myMake: 'My Make',
            myModel: 'My Model',
            myFitmentType: 'My Fitment Type',
          },
        productDetails: {
          skuId: '123123',
          title: 'abc',
          price: 132,
          extra: 1
        }
    };

    // Call runCode to run the template's code.
    let variableResult = runCode(mockData);

    // Verify that the variable returns a result.
    assertApi('gtmOnSuccess').wasCalled();
    assertApi('logToConsole').wasCalledWith('track', {
        type: 'a2c',
        name: 'pdp',
        value: {
            products: [
              {
                sku: '123123',
                price: 132,
                fitments: [
                  {
                    year: 2008,
                    model: 'My Model',
                    make: 'My Make',
                    fit_type: 'My Fitment Type'
                  }
                ]
              }
            ]
        }
    });
- name: maps a product object with auto mapping
  code: |-
    const mockData = {
        type: 'a2c',
        pageName: 'pdp',
        productMapEnabled: true,
         productSkuType: 'prop',
         productSkuProp: 'skuId',
         productPriceType: 'auto',
         productFitmentsMapEnabled: true,
         productFitmentsType: 'prop',
         productFitmentsProp: 'myFitment',
         productFitmentsModelProp: 'myModel',
         productFitmentsYearType: 'auto',
         productFitmentsMakeType: 'auto',
         productFitmentsModelType: 'prop',
         productFitmentsFitTypeProp: 'myFitmentType',
         productFitmentsFitTypeType: 'prop',
         productDetails: {
           skuId: '123123',
           title: 'abc',
           price: 132,
           myFitment: {
               year: 2008,
               make: 'My Make',
               myModel: 'My Model',
               myFitmentType: 'My Fitment Type',
             },
           extra: 1
         }
     };

    // Call runCode to run the template's code.
    let variableResult = runCode(mockData);

    // Verify that the variable returns a result.
    assertApi('gtmOnSuccess').wasCalled();
    assertApi('logToConsole').wasCalledWith('track', {
        type: 'a2c',
        name: 'pdp',
        value: {
            products: [
              {
                sku: '123123',
                price: 132,
                fitments: [
                    {
                      year: 2008,
                      model: 'My Model',
                      make: 'My Make',
                      fit_type: 'My Fitment Type'
                    }
                  ]
              }
            ]
        }
    });
- name: maps a products list
  code: |-
    const mockData = {
        type: 'a2c',
        pageName: 'pdp',
        productMapEnabled: true,
        productSkuType: 'prop',
        productSkuProp: 'skuId',
        productDetails: [{
          skuId: '123123',
          title: 'abc',
          extra: 1
        }]
    };

    // Call runCode to run the template's code.
    let variableResult = runCode(mockData);

    // Verify that the variable returns a result.
    assertApi('gtmOnSuccess').wasCalled();
    assertApi('logToConsole').wasCalledWith('track', {
        type: 'a2c',
        name: 'pdp',
        value: {
            products: [
              {
                sku: '123123',
              }
            ]
        }
    });
- name: maps an empty products list
  code: |-
    const mockData = {
        type: 'a2c',
        pageName: 'pdp',
        productMapEnabled: true,
        productSkuType: 'prop',
        productSkuProp: 'skuId',
        productDetails: []
    };

    // Call runCode to run the template's code.
    let variableResult = runCode(mockData);

    // Verify that the variable returns a result.
    assertApi('gtmOnSuccess').wasNotCalled();
    assertApi('gtmOnFailure').wasCalled();
    assertApi('logToConsole').wasCalledWith('Invalid Products');
- name: maps to a non-values mapped product
  code: |-
    const mockData = {
        type: 'a2c',
        pageName: 'pdp',
        productMapEnabled: true,
        productSkuType: 'prop',
        productSkuProp: 'skuId',
        productDetails: {
            productPrice: 55,
            productSku: '123'
        }
    };

    // Call runCode to run the template's code.
    let variableResult = runCode(mockData);

    // Verify that the variable returns a result.
    assertApi('gtmOnSuccess').wasNotCalled();
    assertApi('gtmOnFailure').wasCalled();
    assertApi('logToConsole').wasCalledWith('Invalid Products');
- name: maps to a non-values mapped fitments
  code: |-
    const mockData = {
        type: 'a2c',
        pageName: 'pdp',
        productMapEnabled: true,
        productSkuType: 'prop',
        productSkuProp: 'skuId',
        productPriceType: 'prop',
        productPriceProp: 'price',
        productFitmentsMapEnabled: true,
        productFitmentsType: 'prop',
        productFitmentsProp: 'fitments',
        productFitmentsModelType: 'prop',
        productFitmentsModelProp: 'skuId',
        productDetails: {
            price: 55,
            skuId: '123',
            fitments: {
                myOtherModel: 2000
            }
        }
    };

    // Call runCode to run the template's code.
    let variableResult = runCode(mockData);

    // Verify that the variable returns a result.
    assertApi('gtmOnSuccess').wasCalled();
    assertApi('logToConsole').wasCalledWith('track', {
        type: 'a2c',
        name: 'pdp',
        value: {
            products: [{
                price: 55,
                sku: '123',
                fitments: undefined,
            }]
        }
    });

- name: Map users - no mapped data
  code: |-
    const mockData = {
        type: 'orderConfirm',
        productMapEnabled: false,
        userMapEnabled: true,
        checkoutMapEnabled: false,
        userIdType: 'auto',
        userDetails: {
            a: 11,
            b: '12',
            c: false
        },
        checkoutDetails: {
            d: 21,
            e: '22',
            f: false
        },
        productDetails: {
            g: 31,
            h: '32',
            i: false
        }
    };

    // Call runCode to run the template's code.
    let variableResult = runCode(mockData);

    // Verify that the variable returns a result.
    assertApi('gtmOnSuccess').wasCalled();
    assertApi('logToConsole').wasCalledWith('track', {
        type: 'order',
        name: 'confirm',
        value: {
            checkout: {
              d: 21,
              e: '22',
              f: false
            },
            products: [
                {
                  g: 31,
                  h: '32',
                  i: false
                }
            ],
            user: undefined
        }
    });

- name: Map users - with prop, var, key-map and auto mapped data
  code: |-
    const mockData = {
        type: 'orderConfirm',
        productMapEnabled: false,
        userMapEnabled: true,
        checkoutMapEnabled: false,
        userIdType: 'prop',
        userIdProp: 'a',
        userFirstNameType: 'var',
        userFirstNameProp: 'Leon',
        userLastNameType: 'auto',
        userCustom: [
            {
                key: 'address',
                type: 'auto',
                prop: ''
            },
            {
                key: 'attributes',
                type: 'prop',
                prop: 'userAttributes'
            }
        ],
        userDetails: {
            a: 11,
            last_name: 'Georgia',
            c: false,
            userAttributes: {
               a: 1,
               b: '2'
            },
            address: {
                street: '123 Fake St.',
                zipcode: 94522
            }
        },
        checkoutDetails: {
            d: 21,
            e: '22',
            f: false
        },
        productDetails: {
            g: 31,
            h: '32',
            i: false
        }
    };

    // Call runCode to run the template's code.
    let variableResult = runCode(mockData);

    // Verify that the variable returns a result.
    assertApi('gtmOnSuccess').wasCalled();
    assertApi('logToConsole').wasCalledWith('track', {
        type: 'order',
        name: 'confirm',
        value: {
            user: {
                id: 11,
                first_name: 'Leon',
                last_name: 'Georgia',
                address: {
                     street: '123 Fake St.',
                     zipcode: 94522
                },
                attributes: {
                    a: 1,
                    b: '2'
                }
            },
            checkout: {
              d: 21,
              e: '22',
              f: false
            },
            products: [
                {
                  g: 31,
                  h: '32',
                  i: false
                }
            ]
        }
    });

- name: Map users - with var key-map mapped data
  code: |-
    const mockData = {
        type: 'orderConfirm',
        productMapEnabled: false,
        userMapEnabled: true,
        checkoutMapEnabled: false,
        userIdType: 'prop',
        userIdProp: 'a',
        userFirstNameType: 'var',
        userFirstNameProp: 'Leon',
        userLastNameType: 'auto',
        userCustom: [
            {
                key: 'attributes',
                type: 'var',
                prop: {
                    a: 1,
                    b: '2'
                }
            }
        ],
        userDetails: {
            a: 11,
            last_name: 'Georgia',
            c: false,
            userAttributes: {
               a: 1,
               b: '2'
            }
        },
        checkoutDetails: {
            d: 21,
            e: '22',
            f: false
        },
        productDetails: {
            g: 31,
            h: '32',
            i: false
        }
    };

    // Call runCode to run the template's code.
    let variableResult = runCode(mockData);

    // Verify that the variable returns a result.
    assertApi('gtmOnSuccess').wasCalled();
    assertApi('logToConsole').wasCalledWith('track', {
        type: 'order',
        name: 'confirm',
        value: {
            user: {
                id: 11,
                first_name: 'Leon',
                last_name: 'Georgia',
                attributes: {
                    a: 1,
                    b: '2'
                }
            },
            checkout: {
              d: 21,
              e: '22',
              f: false
            },
            products: [
                {
                  g: 31,
                  h: '32',
                  i: false
                }
            ]
        }
    });

- name: Map checkout - no mapped data
  code: |-
    const mockData = {
        type: 'orderConfirm',
        productMapEnabled: false,
        userMapEnabled: false,
        checkoutMapEnabled: true,
        checkoutOrderIdType: 'auto',
        userDetails: {
            a: 11,
            b: '12',
            c: false
        },
        checkoutDetails: {
            d: 21,
            e: '22',
            f: false
        },
        productDetails: {
            g: 31,
            h: '32',
            i: false
        }
    };

    // Call runCode to run the template's code.
    let variableResult = runCode(mockData);

    // Verify that the variable returns a result.
    assertApi('gtmOnSuccess').wasNotCalled();
    assertApi('gtmOnFailure').wasCalled();
    assertApi('logToConsole').wasCalledWith('Invalid Checkout Details');

- name: Map checkout - with prop, var and auto mapped data
  code: |-
    const mockData = {
        type: 'orderConfirm',
        productMapEnabled: false,
        userMapEnabled: false,
        checkoutMapEnabled: true,
        checkoutOrderIdType: 'prop',
        checkoutOrderIdProp: 'd',
        checkoutTotalType: 'var',
        checkoutTotalProp: 1030,
        checkoutSubtotalType: 'auto',
        userDetails: {
            a: 11,
            b: '12',
            c: false
        },
        checkoutDetails: {
            d: 21,
            subtotal: 22,
            f: false
        },
        productDetails: {
            g: 31,
            h: '32',
            i: false
        }
    };

    // Call runCode to run the template's code.
    let variableResult = runCode(mockData);

    // Verify that the variable returns a result.
    assertApi('gtmOnSuccess').wasCalled();
    assertApi('logToConsole').wasCalledWith('track', {
        type: 'order',
        name: 'confirm',
        value: {
            user: {
                a: 11,
                b: '12',
                c: false
            },
            checkout: {
              order_id: 21,
              total: 1030,
              subtotal: 22,
            },
            products: [
                {
                  g: 31,
                  h: '32',
                  i: false
                }
            ]
        }
    });

- name: Order Confirm Event - no data
  code: |-
    const mockData = {
        type: 'orderConfirm',
        productMapEnabled: false,
        userMapEnabled: false,
        checkoutMapEnabled: false,
    };

    // Call runCode to run the template's code.
    let variableResult = runCode(mockData);

    // Verify that the variable returns a result.
    assertApi('gtmOnSuccess').wasNotCalled();
    assertApi('gtmOnFailure').wasCalled();
    assertApi('logToConsole').wasCalledWith('Invalid Products');
- name: Order Confirm Event - no products data
  code: |-
    const mockData = {
        type: 'orderConfirm',
        productMapEnabled: false,
        userMapEnabled: false,
        checkoutMapEnabled: false,
        userDetails: {
            a: 11,
            b: '12',
            c: false
        },
        checkoutDetails: {
            d: 21,
            e: '22',
            f: false
        }
    };

    // Call runCode to run the template's code.
    let variableResult = runCode(mockData);

    // Verify that the variable returns a result.
    assertApi('gtmOnSuccess').wasNotCalled();
    assertApi('gtmOnFailure').wasCalled();
    assertApi('logToConsole').wasCalledWith('Invalid Products');
- name: Order Confirm Event - no checkout data
  code: |-
    const mockData = {
        type: 'orderConfirm',
        productMapEnabled: false,
        userMapEnabled: false,
        checkoutMapEnabled: false,
        userDetails: {
            a: 11,
            b: '12',
            c: false
        },
        productDetails: {
            price: 31,
            h: '32',
            i: false
        }
    };

    // Call runCode to run the template's code.
    let variableResult = runCode(mockData);

    // Verify that the variable returns a result.
    assertApi('gtmOnSuccess').wasNotCalled();
    assertApi('gtmOnFailure').wasCalled();
    assertApi('logToConsole').wasCalledWith('Invalid Checkout Details');
- name: Order Confirm Event - no user data
  code: |-
    const mockData = {
        type: 'orderConfirm',
        productMapEnabled: false,
        userMapEnabled: false,
        checkoutMapEnabled: false,
        checkoutDetails: {
            d: 21,
            e: '22',
            f: false
        },
        productDetails: {
            g: 31,
            h: '32',
            i: false
        }
    };

    // Call runCode to run the template's code.
    let variableResult = runCode(mockData);

    // Verify that the variable returns a result.
    assertApi('gtmOnSuccess').wasCalled();
    assertApi('logToConsole').wasCalledWith('track', {
        type: 'order',
        name: 'confirm',
        value: {
            user: undefined,
            checkout: {
              d: 21,
              e: '22',
              f: false
            },
            products: [
                {
                  g: 31,
                  h: '32',
                  i: false
                }
            ]
        }
    });
- name: Order Confirm Event - no mapping
  code: |-
    const mockData = {
        type: 'orderConfirm',
        productMapEnabled: false,
        userMapEnabled: false,
        checkoutMapEnabled: false,
        userDetails: {
            a: 11,
            b: '12',
            c: false
        },
        checkoutDetails: {
            d: 21,
            e: '22',
            f: false
        },
        productDetails: {
            g: 31,
            h: '32',
            i: false
        }
    };

    // Call runCode to run the template's code.
    let variableResult = runCode(mockData);

    // Verify that the variable returns a result.
    assertApi('gtmOnSuccess').wasCalled();
    assertApi('logToConsole').wasCalledWith('track', {
        type: 'order',
        name: 'confirm',
        value: {
            user: {
              a: 11,
              b: '12',
              c: false
            },
            checkout: {
              d: 21,
              e: '22',
              f: false
            },
            products: [
                {
                  g: 31,
                  h: '32',
                  i: false
                }
            ]
        }
    });

- name: Status Cart Event - no data
  code: |-
    const mockData = {
        type: 'statusCart',
        productMapEnabled: false,
    };

    // Call runCode to run the template's code.
    let variableResult = runCode(mockData);

    // Verify that the variable returns a result.
    assertApi('gtmOnSuccess').wasNotCalled();
    assertApi('gtmOnFailure').wasCalled();
    assertApi('logToConsole').wasCalledWith('Invalid Products');
- name: Status Cart Event - no products data
  code: |-
    const mockData = {
        type: 'statusCart',
        productMapEnabled: false,
    };

    // Call runCode to run the template's code.
    let variableResult = runCode(mockData);

    // Verify that the variable returns a result.
    assertApi('gtmOnSuccess').wasNotCalled();
    assertApi('gtmOnFailure').wasCalled();
    assertApi('logToConsole').wasCalledWith('Invalid Products');
- name: Status Cart Event - no mapping
  code: |-
    const mockData = {
        type: 'statusCart',
        productMapEnabled: false,
        productDetails: {
            g: 31,
            h: '32',
            i: false
        }
    };

    // Call runCode to run the template's code.
    let variableResult = runCode(mockData);

    // Verify that the variable returns a result.
    assertApi('gtmOnSuccess').wasCalled();
    assertApi('logToConsole').wasCalledWith('track', {
        type: 'status',
        name: 'cart',
        value: {
            products: [
                {
                  g: 31,
                  h: '32',
                  i: false
                }
            ]
        }
    });

- name: User Login Event - no user data
  code: |-
    const mockData = {
        type: 'userLogin',
        userMapEnabled: false,
    };

    // Call runCode to run the template's code.
    let variableResult = runCode(mockData);

    // Verify that the variable returns a result.
    assertApi('gtmOnSuccess').wasNotCalled();
    assertApi('gtmOnFailure').wasCalled();
    assertApi('logToConsole').wasCalledWith('Invalid User Details');
- name: User Login Event - no mapping
  code: |-
    const mockData = {
        type: 'userLogin',
        userMapEnabled: false,
        userDetails: {
            a: 11,
            b: '12',
            c: false
        },
    };

    // Call runCode to run the template's code.
    let variableResult = runCode(mockData);

    // Verify that the variable returns a result.
    assertApi('gtmOnSuccess').wasCalled();
    assertApi('logToConsole').wasCalledWith('track', {
        type: 'user',
        name: 'login',
        value: {
            user: {
              a: 11,
              b: '12',
              c: false
            },
        }
    });
- name: Update Product Context - no sku list
  code: |-
    const mockData = {
        type: 'productContext',
    };

    // Call runCode to run the template's code.
    let variableResult = runCode(mockData);

    // Verify that the variable returns a result.
    assertApi('gtmOnSuccess').wasNotCalled();
    assertApi('gtmOnFailure').wasCalled();
    assertApi('logToConsole').wasCalledWith('Invalid SKU List');
- name: Update Product Context - no rfkids
  code: |-
    const mockData = {
        type: 'productContext',
        skuList: ['sku1', 'sku2', 'sku3']
    };

    // Call runCode to run the template's code.
    let variableResult = runCode(mockData);

    // Verify that the variable returns a result.
    assertApi('gtmOnSuccess').wasCalled();
    assertApi('logToConsole').wasCalledWith('productContext', {
        context: {
            page: {
                sku: ['sku1', 'sku2', 'sku3']
            }
        }
    });
- name: Update Product Context - with rfkids
  code: |-
    const mockData = {
        type: 'productContext',
        skuList: ['sku1', 'sku2', 'sku3'],
        rfkids: 'rfkid_1, rfkid_30,rfkid_31',
    };

    // Call runCode to run the template's code.
    let variableResult = runCode(mockData);

    // Verify that the variable returns a result.
    assertApi('gtmOnSuccess').wasCalled();
    assertApi('logToConsole').wasCalledWith('productContext', {
        widget: {
            rfkids: ['rfkid_1', 'rfkid_30', 'rfkid_31']
        },
        context: {
            page: {
                sku: ['sku1', 'sku2', 'sku3']
            }
        }
    });
- name: Beacon - inject prod beacon
  code: |-
    const mockData = {
      type: 'beacon',
      env: 'prod',
      ckey: '123-32113123'
    };

    mock('injectScript', function(url, onSuccess, onFailure) {
        onSuccess();
    });

    // Call runCode to run the template's code.
    let variableResult = runCode(mockData);

    // Verify that the variable returns a result.
    assertApi('gtmOnSuccess').wasCalled();
    assertApi('queryPermission').wasCalledWith('inject_script', 'https://32113123-prod.rfksrv.com/rfk/js/123-32113123/init.js');
    assertApi('injectScript').wasCalled();
- name: Beacon - inject uat beacon
  code: |-
    const mockData = {
      type: 'beacon',
      env: 'uat',
      ckey: '123-32113123'
    };

    mock('injectScript', function(url, onSuccess, onFailure) {
        onSuccess();
    });

    // Call runCode to run the template's code.
    let variableResult = runCode(mockData);

    // Verify that the variable returns a result.
    assertApi('gtmOnSuccess').wasCalled();
    assertApi('queryPermission').wasCalledWith('inject_script', 'https://initjs.uat.rfksrv.com/rfk/js/123-32113123/init.js');
    assertApi('injectScript').wasCalled();
- name: Beacon - custom url
  code: |-
    const mockData = {
      type: 'beacon',
      customBeaconUrl: 'https://example.com/init.js',
      env: 'prod',
      ckey: '123-32113123'
    };

    mock('queryPermission', true);
    mock('injectScript', function(url, onSuccess, onFailure) {
        onSuccess();
    });

    // Call runCode to run the template's code.
    let variableResult = runCode(mockData);

    // Verify that the variable returns a result.
    assertApi('gtmOnSuccess').wasCalled();
    assertApi('queryPermission').wasCalledWith('inject_script', 'https://example.com/init.js');
    assertApi('injectScript').wasCalled();
- name: Beacon - custom url fails due to permissions
  code: |-
    const mockData = {
      type: 'beacon',
      customBeaconUrl: 'https://example.com/init.js',
      env: 'prod',
      ckey: '123-32113123'
    };

    mock('queryPermission', false);
    mock('injectScript', function(url, onSuccess, onFailure) {
        onSuccess();
    });

    // Call runCode to run the template's code.
    let variableResult = runCode(mockData);

    // Verify that the variable returns a result.
    assertApi('gtmOnSuccess').wasNotCalled();
    assertApi('gtmOnFailure').wasCalled();
    assertApi('queryPermission').wasCalledWith('inject_script', 'https://example.com/init.js');
    assertApi('injectScript').wasNotCalled();
    assertApi('logToConsole').wasCalledWith('Failed to load init.js due to URL permissions');
___INFO___

{
  "displayName": "Reflektion",
  "description": "Template for setting up Reflektion beacon, context and events",
  "securityGroups": [],
  "id": "cvt_temp_public_id",
  "type": "TAG",
  "version": 1,
  "brand": {
    "thumbnail": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADwAAAA8CAYAAAA6/NlyAAAAAXNSR0IArs4c6QAACPlJREFUaAXlWw1sHMUVnjd75xgwiSGk+C+V0ySkKGrT+GwCNEKhCImqqKWVIBCgggJChQqfTQKlFe2pkaooJPjcFomoPxCiJqL/5UeKUAuhalpSn40LDTTlL2rjs0ubxEnq2rm73en39rxm97yzt3dnJ3Yzkr0zb968ed/8vjczR2KaQkMidbY4JlYrJWIkxDJLiWWCRB0pda4gOteuVqkTiuiEUGJIkjighDhAJHrFPPH7dKL1v9OhGnSZurDoa69fODY6tk4o+jyAXiqEipYjnYgyKLdPkPpl9VnVO9/79sf+WY4cvzJTArgp3rMmJ2i9UOoaVGL4VVQBzcSI2B0RasuhZNueCuTYRSsC3Bjv/ZSlrI0YipdXqkiY8uj5vVLQNwaSsRfD8PvxlAV44QN9DdmM+Sjm3lo/odNOI/F0tMro/MfmlnSpdZUMuDGe+oyp1E5UNLfUyqaY/7hBtG4g2fp8KXJlKcwN7b0bTCGeQZnTDZbVnsu6sE6lYAjVw0u+89ackXeHv4+V99ZShJ8qXmxlO875SO1db9+39GSxOosCXrz+zx8ayWZ/jS0G28xMDvTKOdHo597ZsuL9IC0Dh7Tds7MCLENUl3LHsM5lA+ZhPPN71g0PoG2d3TRvXNvDvBjM1DnrheBNsc5BC5nvHLa3Hl6NldI2iLeaGZYismDufdZvy5oE2DYqTppvAsJM2Hoqacnj0TnGxYXGyaQetC2o2Q+WG2ruOBZPo3l6mG1jU1m/9XDM8oRB8iq37R1x42FHwJ0OE3dcOVLiT3Dn3ofPe1gpg927EoJ5JxabK4IKoJ5/k5APwlHJ6vnM6yDnC+78cUwTzsZED9sunhIvuZkD40QHkb9Z1ortlTrrde09P4Ks27X1kThBhrxycGusV8fT2Nl7rWmqX/j54BESVzqu5UQP2/4s3J+Q4Ynq2vn3HEwsGgvJXzYbemSMV9xDAWAb7u+52sqpn/mB5Yrz2MQejtuLFp9UjDvvTAsMJGjTUHfbl04FWEyPHAljrdM7forVt/ddoXL0KyWU3sLCwYSNEQJswPaxTIiTChjpL999XuzrfhVPPQ2rghJ3pLtb2DvzDU3tqVWKzOfAeLYvwwdEYxxjHrCwyDPRP+DzxqQwHkokyPJSpydFUnRgJD2lk97Q2b/SJLEbjZI/ENQxOnScs3E0wqeLalhcUmz6oncPDCRb/uiU9/su3JBabOZkmyWs8yWOI908lkEvDW1tecNN08WlpG+lu1q7dfkf7uhfnrVyLyilanU8PvRVjDWSP0pVVT4MHhIp0u7PiYSSjx9N/SCbUVhp4ZYjWAUtSJa8G+QQgOX30l2xb9pCfP41bXh1aSaT/Q2yLvDJ1pLQOFV0jFZL7FsxLZcnw96GPBQnse143zrE9duKw1jki732x4PJlvt0bM3xV5vNTI731DodTxCdseL8GwfkYYK0jujYyFSX6fJC04meX1Ybuw2gfffGpo7+xjGVexGZTaFlFjAyVmnfCBRk+CdpgT8du58U2sbQlXHTYf79LkIXXr8nQTk33YnzlmKqLPfsIodWzpexRvj6o2C6+cpSipp9M0CUFNlhilwc0Gt0PEF02LpP6vIbH3pz/ujIf3jOXqTjCU0HVmnf9YQogUm/Qsc28Ogn/haR4nKeg+D5C/74asT7p2hUVz6Iboxl5+HmYWEQT9g8xkr18dRJXsHCFDIosnIgubI/DO9U8tS1p67H6PlJpTLRIZlJ/nCQUEvl7g/Kn668oe7Wn8KkfXwq5EvY0CfCCsIKeUt9ew/vp6c8zDlvfocQ9FpFFQMrG0ShAXNlAP1YQ7znpooq1hSObUtpr1fZWZEiegPm84imeFEyY0UPi6GinF4GA8v7TsyrZ9kQ8GaVn1qe2F+VfkM9g1OX23RS0t0rDmBE3qPLL0rni3e+eS/K6Mugrs1Q7irfrBKJaxIqcmR49GmMnmtwUffdxs5+7RbEDoUk2l5iFTY7Y42gkvIAwzKCgf9DXcX1HX2tyjInFjlYOXsGu9u2+fH/9VhvO3ruunyeqrGs3C70+GX7E8t9j4ouiETv/Vc2uwpu4Uf95OlojBWNhTcVJQYof7g6etadumLNifeqhbLYtbvR+UNlq3T8UuFVhytgm2w5cnRsk4vkib62ZcWIIcUN0KOkExfGKvkBCVa/gIMxT112Qgn68sFHlmvnfmb48EYoffHkkuEp6L14Xbzv07oSh7paX0cerLtwgfdgxir5AA4ttS9cMTQN0S7eF3X8WME/iROCTl1+eDrWVGVtb96wX+sZ2VOEKKxBso+x5g0Pyad9YQKlo9VV9+o42cG2BD2J+ViSQaOTh15ecDIz+hRGC/rEP9TUzrsL/sC7/rkuKl4EccpWjJ8GIZ733F08hVGSdMffN338aCHdSVvDYhPALnHSU/EF6KuxVT2gk/V2YulxImOtPWR1TMA2jjEP2H4HhadBen4MZZh2g10xLQ+fa2NP/0qQjHLzMEU2NnX0XKIrP9jVkoKGD+ryMQ93O2+9JoYev4PSFhD0zoJodL0uH1tIDc5+n4Adph16urLh6CqaU2LXksRbc3X8g8lYEr3ie8LpxuZREHbyXmwfk95coXcflobYq6vMstTtOD65VZfPdFS0Wxq02Y8nTHlbBhGeXsif+8mwaWSdryy1FXGc3ecDhvrewWTr6om0E+HvmXCZNjGkGbB9y4ZHXxz/vwjA4r45ZEwewEzgF26Y5Mc4PqsDMNhYCkBMAsw35pgANwM0FsdZGvJPHm4uvP1nNJMAM5HfRsBR/irHZ2Ng3f3edzAWzypdCK4+3gMrJ3j1LSxzutNwEHYMJtu+qNPDt4cdZn7OhzZ5xUnP/C9e49k66zUNBMxvF/k53+wAnX96WOy9ZSBgbid+u1izeN4aHir6dju9Oawb61jsnSVrGTiHC2HwCzeLFDsIRRuqsOy0pLEa8wKV7o49ElZ+SYBZ6Bn1QJwB83LPL9wwNk6fRcY/AYAOuq2H9dSFknvYLYht71P6Iw8h/iBJPlxoLrp1KhavCLAj/Iz5GY8D2PmeMT/UcgC7vzP1p3j/A/VvXeZabpDxAAAAAElFTkSuQmCC",
    "displayName": "",
    "id": "brand_dummy"
  },
  "containerContexts": [
    "WEB"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "macrosInSelect": false,
    "selectItems": [
      {
        "displayValue": "Beacon",
        "value": "beacon"
      },
      {
        "displayValue": "Context - Product",
        "value": "productContext"
      },
      {
        "displayValue": "Event - Add to Cart",
        "value": "a2c"
      },
      {
        "displayValue": "Event - Order Confirm",
        "value": "orderConfirm"
      },
      {
        "displayValue": "Event - User Login",
        "value": "userLogin"
      }
    ],
    "displayName": "Tag Type",
    "defaultValue": "beacon",
    "simpleValueType": true,
    "name": "type",
    "type": "SELECT"
  },
  {
    "displayName": "Beacon",
    "name": "beacon",
    "groupStyle": "ZIPPY_CLOSED",
    "type": "GROUP",
    "subParams": [
      {
        "help": "Customer Key can be found under Developer Resources tab in CEC",
        "displayName": "Customer Key",
        "simpleValueType": true,
        "name": "ckey",
        "type": "TEXT"
      },
      {
        "macrosInSelect": false,
        "selectItems": [
          {
            "displayValue": "Development",
            "value": "uat"
          },
          {
            "displayValue": "Production",
            "value": "prod"
          }
        ],
        "displayName": "Environment",
        "defaultValue": "prod",
        "simpleValueType": true,
        "name": "env",
        "type": "SELECT"
      }
    ]
  },
  {
    "displayName": "Context",
    "name": "context",
    "groupStyle": "ZIPPY_CLOSED",
    "type": "GROUP",
    "subParams": [
      {
        "help": "Comma separated rfkids. Products Context will be applied to all Reflektion widgets in the page if nothing is specified here. See Reflektion Widget Context Technical Guide for details. (Comma separated rfkids entered here will be converted into a list of rfkids)",
        "displayName": "rfkids",
        "simpleValueType": true,
        "name": "rfkids",
        "type": "TEXT"
      },
      {
        "help": "List of product SKUs. See Reflektion Widget Context Technical Guide for details",
        "displayName": "SKU List",
        "simpleValueType": true,
        "name": "skuList",
        "type": "TEXT"
      }
    ]
  },
  {
    "displayName": "Event",
    "name": "event",
    "groupStyle": "ZIPPY_CLOSED",
    "type": "GROUP",
    "subParams": [
      {
        "help": "Used in Add To Cart events. Examples: pdp, home, category, cart, qview",
        "displayName": "Page Name",
        "simpleValueType": true,
        "name": "pageName",
        "type": "TEXT"
      },
      {
        "help": "List of Product Objects. See Reflektion Events API documentation for details",
        "displayName": "Product Details",
        "simpleValueType": true,
        "name": "productDetails",
        "type": "TEXT"
      },
      {
        "help": "Checkout Object. See Reflektion Events API documentation for details",
        "displayName": "Checkout Details",
        "simpleValueType": true,
        "name": "checkoutDetails",
        "type": "TEXT"
      },
      {
        "help": "User Object. See Reflektion Events API documentation for details",
        "displayName": "User Details",
        "simpleValueType": true,
        "name": "userDetails",
        "type": "TEXT"
      }
    ]
  }
]


___WEB_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "debug"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "inject_script",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://*.rfksrv.com/*"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_globals",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keys",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "rfk"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___SANDBOXED_JS_FOR_WEB_TEMPLATE___

// Enter your template code here.
var log = require('logToConsole');
log('data =', data);

function insertBeacon(data) {
  var query = require('queryPermission'),
    injectScript = require('injectScript'),
    beaconUrlMap = {
      uat: 'https://initjs.uat.rfksrv.com/rfk/js/{ckey}/init.js',
      prod: 'https://{dh}-prod.rfksrv.com/rfk/js/{ckey}/init.js'
    },
    ckey = (data.ckey || '').split(' ').join(''),
    dh = ckey.split('-')[1],
    beaconUrl, errMsg;

  if (ckey && dh) {
    beaconUrl = beaconUrlMap[data.env].replace('{dh}', dh).replace('{ckey}', ckey);

    if (query('inject_script', beaconUrl)) {
      injectScript(beaconUrl, data.gtmOnSuccess, data.gtmOnFailure);
      log(beaconUrl);
    }
    else {
      errMsg = 'Failed to load init.js due to URL permissions';
    }
  }
  else {
    errMsg = 'Invalid Customer Key';
  }
  if (errMsg) {
    log(errMsg);
    data.gtmOnFailure();
  }
}

function updateProductContext(data) {
  var createQueue = require('createQueue'),
    skuList = data.skuList,
    rfkids = (data.rfkids||'').split(' ').join(''),
    context, rfkPush;

  if (skuList && skuList.length) {
    context = { context: { page: { sku: skuList } } };
    if (rfkids && rfkids.length) {
      if (typeof rfkids == 'string')
        rfkids = rfkids.split(',');
      context.widget = { rfkids: rfkids };
    }
    rfkPush = createQueue('rfk');
    rfkPush(['updateContext', context]);
    data.gtmOnSuccess();
  }
  else {
    log('Invalid SKU List');
    data.gtmOnFailure();
  }
}

function pushEvent(data) {
  var createQueue = require('createQueue'),
    pageName = data.pageName,
    productsList = data.productDetails,
    checkoutDetails = data.checkoutDetails,
    userDetails = data.userDetails,
    value = {},
    errMsg = '',
    eventObject, rfkPush;

  if (productsList && productsList.length) {
    value.products = productsList;
  }
  if (checkoutDetails) {
    value.checkout = checkoutDetails;
  }
  if (userDetails) {
    value.user = userDetails;
  }

  switch (data.type) {
    case 'a2c':
      if (pageName) {
        if (value.products) {
          eventObject = {
            type: 'a2c',
            name: pageName,
            value: value
          };
        }
        else {
          errMsg = 'Invalid Products';
        }
      }
      else {
        errMsg = 'No Page Name specified';
      }
      break;

    case 'orderConfirm':
      if (value.products) {
        if (value.checkout) {
          eventObject = {
            type: 'order',
            name: 'confirm',
            value: value
          };
        }
        else {
          errMsg = 'Invalid Checkout Details';
        }
      }
      else {
        errMsg = 'Invalid Products';
      }
      break;

    case 'userLogin':
      if (value.user) {
        eventObject = {
          type: 'user',
          name: 'login',
          value: value
        };
      }
      else {
        errMsg = 'Invalid User Details';
      }
      break;
  }

  if (eventObject) {
    rfkPush = createQueue('rfk');
    rfkPush(['trackEvent', eventObject]);
    data.gtmOnSuccess();
  }
  else {
    log(errMsg);
    data.gtmOnFailure();
  }
}

switch (data.type) {
  case 'beacon':
    insertBeacon(data);
    break;

  case 'productContext':
    updateProductContext(data);
    break;

  case 'a2c':
  case 'orderConfirm':
  case 'userLogin':
    pushEvent(data);
    break;
}


___NOTES___

Created on 9/18/2019, 6:01:23 PM
